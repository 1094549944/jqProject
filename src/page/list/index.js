/*
 * @Author: jiaxinying 
 * @Date: 2018-08-22 14:56:33 
 * @Last Modified by: jiaxinying
 * @Last Modified time: 2018-08-23 11:09:35
 * oderBy:orderBy| default|asc|desc
 */

/**
 * 
 * 列表页面返回参数
 * {
  "status": 0,
  "data": {
    "pageNum": 1,
    "pageSize": 20,
    "size": 14,
    "orderBy": null,
    "startRow": 1,
    "endRow": 14,
    "total": 14,
    "pages": 1,
    "list": [
      {
        "id": 137,
        "categoryId": 100012,
        "name": "冰箱子",
        "subtitle": "冰箱",
        "mainImage": null,
        "price": 2,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 268,
        "categoryId": 100296,
        "name": "Midea222/美的di BCD-535WKZM(E)冰箱双开门无霜智能家用厨卫家电",
        "subtitle": "送品牌烤箱，五一大促",
        "mainImage": "fe6dc6dd-e892-4834-a9c0-1d60de8bbad0.jpg",
        "price": 3338,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 513,
        "categoryId": 100575,
        "name": "海尔 BCD-572WDENU1 冰箱",
        "subtitle": "变频智控， 低温净味， 隐藏门把手",
        "mainImage": "7dc68cad-369b-46d3-ad87-2668c94cf7c0.jpg",
        "price": 3695,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1125,
        "categoryId": 100092,
        "name": "大象冰箱",
        "subtitle": "哈哈",
        "mainImage": null,
        "price": 1,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1176,
        "categoryId": 100006,
        "name": "TCL 515升 风冷无霜对开门冰箱 电脑控温 智慧摆风纤薄机身（流光金）BCD-515WEFA1",
        "subtitle": "双开门冰箱",
        "mainImage": null,
        "price": 2499,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1177,
        "categoryId": 100006,
        "name": "TCL 515升 风冷无霜对开门冰箱 电脑控温 智慧摆风纤薄机身（流光金）BCD-515WEFA1",
        "subtitle": "双开门冰箱",
        "mainImage": null,
        "price": 2499,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1178,
        "categoryId": 100006,
        "name": "TCL 515升 风冷无霜对开门冰箱 电脑控温 智慧摆风纤薄机身（流光金）BCD-515WEFA1",
        "subtitle": "双开门冰箱",
        "mainImage": null,
        "price": 2499,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1179,
        "categoryId": 100006,
        "name": "TCL 515升 风冷无霜对开门冰箱 电脑控温 智慧摆风纤薄机身（流光金）BCD-515WEFA1",
        "subtitle": "双开门冰箱",
        "mainImage": null,
        "price": 2499,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1180,
        "categoryId": 100006,
        "name": "云米（VIOMI）456升大容量 风冷无霜家用对开门大冰箱 智能WIFI操控 静音保鲜 BCD-456WMSD",
        "subtitle": "冰箱",
        "mainImage": "65b6be8b-8bba-4454-9fa6-3e85baead87b.jpg",
        "price": 1998,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1183,
        "categoryId": 100006,
        "name": "TCL 515升 风冷无霜对开门冰箱 电脑控温 智慧摆风纤薄机身（流光金）BCD-515WEFA1",
        "subtitle": "双开门冰箱",
        "mainImage": "de6d956a-3dd7-436c-a241-9f5a0806cd51.jpg",
        "price": 2499,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1209,
        "categoryId": 26,
        "name": "TCL 515升 风冷无霜对开门冰箱 电脑控温 智慧摆风纤薄机身（流光金）BCD-515WEFA1",
        "subtitle": "双开门冰箱",
        "mainImage": "",
        "price": 89,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1258,
        "categoryId": 2,
        "name": "双开门电冰箱",
        "subtitle": "老好了",
        "mainImage": "f03c6700-b6ac-48e5-b341-39b365a0dc82.jpg",
        "price": 9999,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 1260,
        "categoryId": 2,
        "name": "双开门冰箱",
        "subtitle": "可以装大象",
        "mainImage": "",
        "price": 9999,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      },
      {
        "id": 2061,
        "categoryId": 100001,
        "name": "冰箱",
        "subtitle": "sdfdsf",
        "mainImage": null,
        "price": 12,
        "status": 1,
        "imageHost": "http://img.happymmall.com/"
      }
    ],
    "firstPage": 1,
    "prePage": 0,
    "nextPage": 0,
    "lastPage": 1,
    "isFirstPage": true,
    "isLastPage": true,
    "hasPreviousPage": false,
    "hasNextPage": false,
    "navigatePages": 8,
    "navigatepageNums": [
      1
    ]
  }
}
 * 
 * 
 * 
 */

'use strict';
require('./index.css')
require('page/common/header/index.js')
require('page/common/nav/index.js')
var _product = require('service/product-service.js')
var Pagination = require('util/pagination/index.js')
var templateIndex = require('./index.string')
var _mm = require('util/mm.js')


var page = {
  data: {
    listParam: {
      keyword: _mm.getUrlParam('keyword') || '',
      categoryId: _mm.getUrlParam('categoryId') || '',
      orderBy: _mm.getUrlParam('orderBy') || 'default',
      pageNum: _mm.getUrlParam('pageNum') || 1,
      pageSize: _mm.getUrlParam('pageSize') || 20
    }
  },
  init: function () {
    this.onLoad()
    this.bindEvent()
  },
  onLoad: function () {
    this.loadList()
  },
  //加载list数据
  loadList: function () {
    var _this = this,
      listHtml = '',
      listParam = {},
      listParamGet = this.data.listParam,
      $pListCon = $('.p-list-con')
    //loading框加载
    $pListCon.html('<div class="loading"></div>')
    //对参数进行过滤

    for (var key in listParamGet) {
      if ((listParamGet[key] !== '' || listParamGet)) {
        var val = listParamGet[key]
        if ((typeof val === 'string' && val) || (typeof val === 'number' && val > -1)) {
          listParam[key] = listParamGet[key]
        }
      }
    }

    //请求数据
    _product.getProductList(listParam, function (res) {
      listHtml = _mm.renderHtml(templateIndex, {
        list: res.list
      });
      $pListCon.html(listHtml);
      //分页插件
      _this.loadPagination({
        hasPreviousPage: res.hasPreviousPage,
        prePage: res.prePage,
        hasNextPage: res.hasNextPage,
        nextPage: res.nextPage,
        pageNum: res.pageNum,
        pages: res.pages
      });
    }, function (errMsg) {
      _mm.errorTips(errMsg);
    });

  },
  //加载分页
  loadPagination: function (pageInfo) {
    var _this = this;
    //使用类和对象的区别
    //类在一个页面，多次调用，不会互相一项；但是对象会；所用使用类方法。new 
    this.pagination ? '' : (this.pagination = new Pagination());
    this.pagination.render($.extend({}, pageInfo, {
      container: $('.pagination'),
      onSelectPage: function (pageNum) {
        _this.data.listParam.pageNum = pageNum;
        _this.loadList();
      }
    }));
  },
  //绑定事件
  bindEvent: function () {
    var _this = this;
    // 排序的点击事件
    $('.sort-item').click(function () {
      var $this = $(this);
      _this.data.listParam.pageNum = 1;
      // 点击默认排序
      if ($this.data('type') === 'default') {
        // 已经是active样式
        if ($this.hasClass('active')) {
          return;
        }
        // 其他
        else {
          $this.addClass('active').siblings('.sort-item')
            .removeClass('active asc desc');
          _this.data.listParam.orderBy = 'default';
        }
      }
      // 点击价格排序
      else if ($this.data('type') === 'price') {
        // active class 的处理
        $this.addClass('active').siblings('.sort-item')
          .removeClass('active asc desc');
        // 升序、降序的处理
        if (!$this.hasClass('asc')) {
          //升序
          $this.addClass('asc').removeClass('desc');
          _this.data.listParam.orderBy = 'price_asc';
        } else {
          //降序
          $this.addClass('desc').removeClass('asc');
          _this.data.listParam.orderBy = 'price_desc';
        }
      }
      // 重新加载列表
      _this.loadList();
    });
  },
}
$(function () {
  page.init();
})